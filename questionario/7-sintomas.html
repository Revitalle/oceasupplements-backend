<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sintomas Gerais - Ocea Supplements</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- Estilos globais do question√°rio -->
    <link rel="stylesheet" href="estilos-questionario.css">

    <style>
        /* Estilos espec√≠ficos para textarea */
        .textarea-container {
            margin: 1.5rem 0;
        }

        .textarea-wrapper {
            position: relative;
        }

        textarea.form-textarea {
            width: 100%;
            min-height: 250px;
            padding: 1.5rem;
            border: 3px solid var(--neutral-bg);
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-dark);
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.3s;
            background-color: var(--neutral-bg);
        }

        textarea.form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: white;
        }

        textarea.form-textarea::placeholder {
            color: #999;
        }

        /* Contador de palavras */
        .word-counter {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            padding: 0.5rem 1rem;
            background: white;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .word-count {
            font-weight: 600;
            color: var(--primary-color);
        }

        .word-count.warning {
            color: #F0AD4E;
        }

        .word-count.error {
            color: #D9534F;
        }

        .word-limit-info {
            color: #666;
            font-size: 0.85rem;
        }

        /* Instru√ß√µes adicionais */
        .textarea-instructions {
            background: #e8f5e9;
            border-left: 4px solid var(--primary-color);
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
        }

        .textarea-instructions h4 {
            color: var(--primary-color);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .textarea-instructions ul {
            margin: 0;
            padding-left: 1.5rem;
            color: #666;
        }

        .textarea-instructions li {
            margin-bottom: 0.25rem;
        }

        /* Bot√£o Voltar Verde */
        .btn-prev {
            background: var(--primary-color) !important;
            color: white !important;
        }

        .btn-prev:hover {
            background: var(--secondary-color) !important;
        }
    </style>
</head>
<body>

    <!-- Header fixo -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <img src="/assets/images/logo-ocea.png" alt="Ocea Supplements" style="max-width: 195px; max-height: 29px;">
            </div>
            <div class="d-flex align-items-center gap-3">
                <span class="user-greeting" id="user-greeting"></span>
                <button class="btn-logout" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> Sair
                </button>
            </div>
        </div>
    </header>

    <!-- Imagem de capa -->
    <picture>
        <source media="(min-width: 1024px)" srcset="/assets/images/questionario/headers/7-sintomas.png">
        <img src="/assets/images/questionario/headers/7-sintomas-mobile.png" alt="Sintomas Gerais" class="cover-image">
    </picture>

    <!-- Barra de progresso -->
    <div class="progress-container">
        <div class="container">
            <div class="progress-wrapper">
                <div class="progress-bar-custom" id="progress-bar" style="width: 100%">
                    <div class="progress-thumb">100%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Question√°rio -->
    <section class="questionnaire-section">

        <h1 class="section-title">
            üìã Sintomas Gerais
        </h1>
        <p class="section-description">
            √öltima etapa! Descreva os sintomas que voc√™ sente frequentemente e qualquer informa√ß√£o adicional que considere relevante para sua avalia√ß√£o de sa√∫de.
        </p>

        <form id="sintomas-form">

            <div class="question-block">
                <div class="question-text">Descreva seus sintomas e observa√ß√µes gerais:</div>

                <div class="textarea-instructions">
                    <h4><i class="bi bi-info-circle"></i> Orienta√ß√µes:</h4>
                    <ul>
                        <li>Descreva os sintomas que voc√™ sente com frequ√™ncia</li>
                        <li>Inclua informa√ß√µes sobre intensidade, frequ√™ncia e quando acontecem</li>
                        <li>Mencione medicamentos ou suplementos que voc√™ toma regularmente</li>
                        <li>Limite: 300 palavras</li>
                    </ul>
                </div>

                <div class="textarea-container">
                    <div class="textarea-wrapper">
                        <textarea
                            id="sintomas-textarea"
                            name="sintomas"
                            class="form-textarea"
                            placeholder="Exemplo: Sinto fadiga constante principalmente nas tardes, tenho dores de cabe√ßa frequentes (3-4 vezes por semana), dificuldade para dormir, acordo cansado mesmo depois de 8 horas de sono. Tamb√©m percebo que tenho muita reten√ß√£o de l√≠quidos e incha√ßo nas pernas no final do dia. Tomo vitamina D 2000UI diariamente conforme prescri√ß√£o m√©dica..."
                        ></textarea>
                    </div>
                    <div class="word-counter">
                        <span class="word-count" id="word-count">0 palavras</span>
                        <span class="word-limit-info">M√°ximo: 300 palavras</span>
                    </div>
                </div>
            </div>

        </form>

        <!-- Bot√µes de navega√ß√£o -->
        <div class="navigation-buttons">
            <button type="button" class="btn-finish" id="btn-finish" onclick="finishQuestionnaire()">
                FINALIZAR ANAMNESE
            </button>
            <button type="button" class="btn-prev" onclick="goBack()">
                EDITAR RESPOSTAS ANTERIORES
            </button>
        </div>

    </section>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- API Client -->
    <script src="/js/api.js"></script>

    <script>
        const MAX_WORDS = 300;

        // =============================================
        // INICIALIZA√á√ÉO
        // =============================================

        async function init() {
            // Verificar autentica√ß√£o
            if (!API.Auth.isAuthenticated()) {
                window.location.href = '/login.html';
                return;
            }

            // Exibir nome do usu√°rio
            try {
                const response = await API.Auth.getCurrentUser();
                if (response.success && response.data && response.data.name) {
                    const firstName = response.data.name.split(' ')[0];
                    document.getElementById('user-greeting').textContent = `Ol√°, ${firstName}`;
                }
            } catch (error) {
                console.error('Erro ao carregar usu√°rio:', error);
            }

            // Carregar dados salvos (se houver)
            loadSavedData();

            // Configurar event listeners
            setupEventListeners();
        }

        // =============================================
        // EVENT LISTENERS
        // =============================================

        function setupEventListeners() {
            const textarea = document.getElementById('sintomas-textarea');

            // Atualizar contador de palavras ao digitar
            textarea.addEventListener('input', function() {
                updateWordCount();
            });

            // Tamb√©m atualizar ao colar conte√∫do
            textarea.addEventListener('paste', function() {
                setTimeout(updateWordCount, 10);
            });
        }

        // =============================================
        // CONTADOR DE PALAVRAS
        // =============================================

        function updateWordCount() {
            const textarea = document.getElementById('sintomas-textarea');
            const text = textarea.value.trim();

            // Contar palavras (separadas por espa√ßos)
            const words = text.length > 0 ? text.split(/\s+/).filter(word => word.length > 0) : [];
            const wordCount = words.length;

            // Atualizar display
            const wordCountElement = document.getElementById('word-count');
            wordCountElement.textContent = `${wordCount} ${wordCount === 1 ? 'palavra' : 'palavras'}`;

            // Mudar cor baseado no limite
            if (wordCount > MAX_WORDS) {
                wordCountElement.className = 'word-count error';
            } else if (wordCount > MAX_WORDS * 0.9) {
                wordCountElement.className = 'word-count warning';
            } else {
                wordCountElement.className = 'word-count';
            }
        }

        // =============================================
        // VALIDA√á√ÉO DO FORMUL√ÅRIO
        // =============================================
        // (Campo opcional - valida√ß√£o de 300 palavras est√° em finishQuestionnaire)

        // =============================================
        // COLETAR DADOS DO FORMUL√ÅRIO
        // =============================================

        function getFormData() {
            const textarea = document.getElementById('sintomas-textarea');
            return {
                sintomas_texto: textarea.value.trim()
            };
        }

        // =============================================
        // FINALIZAR QUESTION√ÅRIO
        // =============================================

        async function finishQuestionnaire() {
            // Validar limite de palavras antes de continuar
            const textarea = document.getElementById('sintomas-textarea');
            const text = textarea.value.trim();

            if (text.length > 0) {
                const words = text.split(/\s+/).filter(word => word.length > 0);
                if (words.length > 300) {
                    alert('Por favor, reduza seu texto para no m√°ximo 300 palavras.\nAtualmente voc√™ tem ' + words.length + ' palavras.');
                    textarea.focus();
                    return;
                }
            }

            const btnFinish = document.getElementById('btn-finish');
            btnFinish.disabled = true;
            btnFinish.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processando...';

            try {
                // Coletar dados desta se√ß√£o
                const sintomasData = getFormData();
                localStorage.setItem('anamnese_sintomas', JSON.stringify(sintomasData));

                // Coletar TODOS os dados das se√ß√µes anteriores
                const introData = JSON.parse(localStorage.getItem('anamnese_intro') || '{}');
                const nutricaoData = JSON.parse(localStorage.getItem('anamnese_nutricao') || '{}');
                const digestivaData = JSON.parse(localStorage.getItem('anamnese_digestiva') || '{}');
                const fisicaData = JSON.parse(localStorage.getItem('anamnese_fisica') || '{}');
                const sonoData = JSON.parse(localStorage.getItem('anamnese_sono') || '{}');
                const mentalData = JSON.parse(localStorage.getItem('anamnese_mental') || '{}');
                const hormonalData = JSON.parse(localStorage.getItem('anamnese_hormonal') || '{}');

                const anamneseCompleta = {
                    intro: introData,
                    nutricao: nutricaoData,
                    digestiva: digestivaData,
                    fisica: fisicaData,
                    sono: sonoData,
                    mental: mentalData,
                    hormonal: hormonalData,
                    sintomas: sintomasData
                };

                console.log('Anamnese completa:', anamneseCompleta);

                // Enviar para API
                const sessionId = Date.now(); // Simular session_id por enquanto
                const response = await API.Questionnaire.completeSession(sessionId, anamneseCompleta);

                console.log('Resposta da API:', response);

                if (response.success) {
                    const diagnosticId = response.data.diagnostic_id;

                    // Limpar IDs antigos antes de salvar o novo
                    localStorage.removeItem('current_diagnostic_id');
                    localStorage.removeItem('last_diagnostic_id');

                    // Salvar o ID correto do banco
                    localStorage.setItem('current_diagnostic_id', diagnosticId);
                    localStorage.setItem('last_diagnostic_id', diagnosticId);

                    console.log('Diagn√≥stico criado com ID:', diagnosticId);
                    console.log('Tipo do ID:', typeof diagnosticId);
                    console.log('Redirecionando para processamento...');

                    // Redirecionar para p√°gina de processamento
                    window.location.href = '/questionario/processando.html';
                } else {
                    throw new Error('Erro ao salvar question√°rio: ' + (response.error?.message || 'Erro desconhecido'));
                }

            } catch (error) {
                console.error('Erro ao finalizar anamnese:', error);
                alert('Erro ao finalizar anamnese. Tente novamente.\n' + error.message);
                btnFinish.disabled = false;
                btnFinish.innerHTML = '<i class="bi bi-check-circle me-2"></i> Finalizar Anamnese';
            }
        }

        // =============================================
        // CARREGAR DADOS SALVOS
        // =============================================

        function loadSavedData() {
            const savedData = localStorage.getItem('anamnese_sintomas');
            if (!savedData) {
                return;
            }

            try {
                const data = JSON.parse(savedData);

                // Restaurar textarea
                if (data.sintomas_texto) {
                    const textarea = document.getElementById('sintomas-textarea');
                    textarea.value = data.sintomas_texto;
                    updateWordCount();
                }
            } catch (error) {
                console.error('Erro ao carregar dados salvos:', error);
            }
        }

        // =============================================
        // NAVEGA√á√ÉO
        // =============================================

        function goBack() {
            // Salvar dados antes de voltar
            const sintomasData = getFormData();
            localStorage.setItem('anamnese_sintomas', JSON.stringify(sintomasData));

            window.location.href = '/questionario/6-hormonal.html';
        }

        function logout() {
            if (confirm('Tem certeza que deseja sair? Seu progresso ser√° salvo.')) {
                API.Auth.logout();
            }
        }

        // =============================================
        // INICIAR AO CARREGAR P√ÅGINA
        // =============================================

        window.addEventListener('DOMContentLoaded', init);
    </script>

</body>
</html>
