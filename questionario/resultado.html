<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa da Sa√∫de - Ocea Supplements</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --ocea-primary: #007c8c;
            --ocea-dark: #005F6B;
            --color-otimo: #007c8c;      /* √ìtimo: Turquesa */
            --color-intermediario: #F0AD4E; /* Intermedi√°rio: Amarelo */
            --color-ruim: #D9534F;       /* Ruim: Vermelho */
            --color-pessimo: #8B2E3E;    /* P√©ssimo: Vinho */
            --text-dark: #4c4748;
            --bg-light: #f8f9fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
        }

        /* Header */
        .header {
            background: var(--ocea-primary);
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .logo img {
            height: 40px;
            width: auto;
        }

        .user-greeting {
            color: white;
            font-weight: 600;
        }

        /* Container Principal */
        .health-chart-result {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .chart-section {
            background: white;
            border-radius: 20px;
            padding: 3rem 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
            margin-bottom: 2rem;
        }

        .chart-title {
            font-size: 2rem;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        .chart-subtitle {
            font-size: 1.2rem;
            font-weight: 300;
            margin-bottom: 2rem;
            color: var(--text-dark);
        }

        /* SVG Container */
        .svg-container {
            max-width: 700px;
            margin: 0 auto 2rem;
            position: relative;
        }

        .health-svg {
            width: 100%;
            height: auto;
        }

        /* Anima√ß√µes */
        @keyframes slice-fade-in {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes bubble-pop {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .slice-animate {
            animation: slice-fade-in 0.6s ease-out forwards;
            opacity: 0;
        }

        .slice-animate:nth-child(1) { animation-delay: 0.1s; }
        .slice-animate:nth-child(2) { animation-delay: 0.2s; }
        .slice-animate:nth-child(3) { animation-delay: 0.3s; }
        .slice-animate:nth-child(4) { animation-delay: 0.4s; }
        .slice-animate:nth-child(5) { animation-delay: 0.5s; }
        .slice-animate:nth-child(6) { animation-delay: 0.6s; }

        .bolinha {
            animation: bubble-pop 0.5s ease-out forwards;
        }

        /* Legenda */
        .legend-container {
            background: white;
            border-radius: 30px;
            padding: 1rem 2rem;
            display: inline-flex;
            align-items: center;
            gap: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .legend-text {
            font-size: 0.95rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-dark);
        }

        /* Descri√ß√£o */
        .chart-description {
            max-width: 800px;
            margin: 2rem auto;
            text-align: center;
        }

        .chart-description h4 {
            font-size: 1.3rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        .chart-description p {
            font-size: 1rem;
            line-height: 1.6;
            color: #666;
        }

        /* Bot√µes de A√ß√£o */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 2rem;
        }

        .btn-action {
            padding: 1rem 2rem;
            border-radius: 50px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-action.primary {
            background: var(--ocea-primary);
            color: white;
        }

        .btn-action.primary:hover {
            background: var(--ocea-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,124,140,0.3);
        }

        .btn-action.secondary {
            background: white;
            color: var(--ocea-primary);
            border: 2px solid var(--ocea-primary);
        }

        .btn-action.secondary:hover {
            background: var(--ocea-primary);
            color: white;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .chart-title {
                font-size: 1.5rem;
            }

            .chart-subtitle {
                font-size: 1rem;
            }

            .legend-container {
                flex-direction: column;
                gap: 0.5rem;
                padding: 1rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn-action {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div class="logo">
                    <img src="/assets/images/logo-ocea.png" alt="Ocea Supplements">
                </div>
                <div class="user-greeting" id="user-greeting">
                    Ol√°!
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="health-chart-result">

        <!-- Chart Section -->
        <div class="chart-section">
            <h1 class="chart-title" id="user-name-title">SEU MAPA DA SA√öDE</h1>
            <h2 class="chart-subtitle">ESTE √â O RESULTADO DO SEU <strong>MAPA DA SA√öDE</strong></h2>

            <!-- SVG Chart Container -->
            <div class="svg-container" id="svg-container">
                <!-- SVG ser√° gerado aqui dinamicamente -->
            </div>

            <!-- Legenda -->
            <div class="legend-container">
                <div class="legend-item">
                    <div class="legend-dot" style="background: var(--color-otimo);"></div>
                    <span class="legend-text">√ìtimo</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: var(--color-intermediario);"></div>
                    <span class="legend-text">Intermedi√°rio</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: var(--color-ruim);"></div>
                    <span class="legend-text">Ruim</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: var(--color-pessimo);"></div>
                    <span class="legend-text">P√©ssimo</span>
                </div>
            </div>

            <!-- Descri√ß√£o -->
            <div class="chart-description">
                <h4>Cada √°rea representa uma dimens√£o essencial da sua sa√∫de.</h4>
                <p>
                    Quanto maior a porcentagem, melhor est√° esse aspecto no momento atual.
                    Use este panorama para identificar seus pontos fortes e o que pode ser
                    aprimorado com apoio nutricional, mudan√ßas de h√°bito e autocuidado.
                </p>
            </div>

            <!-- Bot√µes de A√ß√£o -->
            <div class="action-buttons">
                <a href="/dashboard.html" class="btn-action primary">
                    <i class="bi bi-house"></i> Ir para Dashboard
                </a>
                <a href="/backend/questionario/intro.html" class="btn-action secondary">
                    <i class="bi bi-arrow-clockwise"></i> Refazer Anamnese
                </a>
                <button onclick="window.print()" class="btn-action secondary">
                    <i class="bi bi-printer"></i> Imprimir Resultados
                </button>
            </div>
        </div>

    </div>

    <!-- API Client -->
    <script src="/js/api.js"></script>

    <script>
        // =============================================
        // CONFIGURA√á√ïES
        // =============================================

        const CATEGORY_CONFIG = {
            intro: { label: 'Corpo', color: null }, // N√£o exibir no gr√°fico
            nutrition: { label: 'Nutri√ß√£o', color: '#4c894f' },
            physical: { label: 'Exerc√≠cio', color: '#3f884b' },
            hormonal: { label: 'Homem/Mulher', color: '#eccc69', dynamic: true }, // Din√¢mico
            digestive: { label: 'Digest√£o', color: '#e5c563' },
            sleep: { label: 'Sono', color: '#a3334d' },
            mental: { label: 'Mente', color: '#942e49' }
            // symptoms √© removido
        };

        // Cores por faixa de score (4 n√≠veis)
        function getColorByScore(score) {
            if (score >= 75) return '#007c8c'; // √ìtimo: Turquesa (75-100)
            if (score >= 50) return '#F0AD4E'; // Intermedi√°rio: Amarelo (50-74)
            if (score >= 25) return '#D9534F'; // Ruim: Vermelho (25-49)
            return '#8B2E3E'; // P√©ssimo: Vinho (0-24)
        }

        // =============================================
        // CARREGAR DIAGN√ìSTICO
        // =============================================

        async function loadDiagnostic() {
            try {
                // Carregar dados do usu√°rio
                const userResponse = await API.Auth.getCurrentUser();
                if (userResponse.success && userResponse.data) {
                    const firstName = userResponse.data.name.split(' ')[0];
                    document.getElementById('user-greeting').textContent = `Ol√°, ${firstName}!`;
                    document.getElementById('user-name-title').textContent = `${firstName.toUpperCase()}, SEU MAPA DA SA√öDE`;
                }

                // Carregar diagn√≥stico
                const response = await API.Diagnostics.getAll();

                if (!response.success || !response.data) {
                    alert('Nenhum diagn√≥stico encontrado. Complete o question√°rio primeiro.');
                    window.location.href = '/backend/questionario/intro.html';
                    return;
                }

                // getAll retorna um objeto √∫nico (n√£o array)
                const diagnostic = response.data;

                // Preparar dados para o gr√°fico
                const chartData = prepareChartData(diagnostic);

                // Gerar SVG
                generateHealthChart(chartData);

            } catch (error) {
                console.error('Erro ao carregar diagn√≥stico:', error);
                alert('Erro ao carregar seus resultados. Tente novamente.');
            }
        }

        // =============================================
        // PREPARAR DADOS DO GR√ÅFICO
        // =============================================

        function prepareChartData(diagnostic) {
            console.log('üìä prepareChartData - diagnostic:', diagnostic);
            const categories = [];

            // Extrair g√™nero do questionnaire_data
            const gender = diagnostic.questionnaire_data?.intro?.sexo ||
                          diagnostic.questionnaire_data?.intro?.genero ||
                          'masculino';

            console.log('üë§ G√™nero detectado:', gender);

            // Mapear categorias (exceto intro e symptoms)
            const categoryOrder = ['nutrition', 'physical', 'hormonal', 'digestive', 'sleep', 'mental'];

            categoryOrder.forEach(key => {
                const config = CATEGORY_CONFIG[key];
                if (!config) return;

                let label = config.label;
                let score = diagnostic[`${key}_score`] || 0;

                console.log(`üìà ${key}_score:`, score);

                // Ajustar label din√¢mica para hormonal
                if (key === 'hormonal' && config.dynamic) {
                    label = gender.toLowerCase() === 'feminino' ? 'Mulher' : 'Homem';
                }

                // Determinar cor baseada no score
                const color = getColorByScore(score);

                categories.push({
                    key,
                    label,
                    score: Math.round(score),
                    color
                });
            });

            console.log('‚úÖ Categorias preparadas:', categories);
            return categories;
        }

        // =============================================
        // GERAR GR√ÅFICO SVG
        // =============================================

        function generateHealthChart(categories) {
            const svgNS = "http://www.w3.org/2000/svg";
            const width = 800;
            const height = 850; // Aumentado para acomodar bolinhas inferiores
            const centerX = 400;
            const centerY = 400;
            const radius = 360;
            const innerRadius = 180; // Reduzido para dar mais espa√ßo aos labels
            const bubbleRadius = 50;

            // Criar SVG
            const svg = document.createElementNS(svgNS, 'svg');
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', '100%');
            svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
            svg.classList.add('health-svg');

            // Criar defs para filtros
            const defs = document.createElementNS(svgNS, 'defs');

            // Filtro de sombra para fatias
            const sliceShadow = document.createElementNS(svgNS, 'filter');
            sliceShadow.setAttribute('id', 'slice-shadow');
            sliceShadow.innerHTML = '<feDropShadow dx="0" dy="2" stdDeviation="4" flood-color="#000" flood-opacity="0.25"/>';
            defs.appendChild(sliceShadow);

            // Filtro de sombra para c√≠rculos
            const circleShadow = document.createElementNS(svgNS, 'filter');
            circleShadow.setAttribute('id', 'circle-shadow');
            circleShadow.innerHTML = '<feDropShadow dx="0" dy="0" stdDeviation="10" flood-color="#000" flood-opacity="0.3"/>';
            defs.appendChild(circleShadow);

            svg.appendChild(defs);

            // Calcular √¢ngulos
            const angleSize = 360 / categories.length;
            let currentAngle = -90; // Come√ßar no topo

            categories.forEach((cat, index) => {
                const startAngle = currentAngle;
                const endAngle = currentAngle + angleSize;

                // Criar fatia (path)
                const path = createDonutSlice(centerX, centerY, radius, innerRadius, startAngle, endAngle);
                const pathElement = document.createElementNS(svgNS, 'path');
                pathElement.setAttribute('d', path);
                pathElement.setAttribute('fill', cat.color);
                pathElement.setAttribute('filter', 'url(#slice-shadow)');
                pathElement.classList.add('slice-animate');
                svg.appendChild(pathElement);

                // Calcular posi√ß√£o do c√≠rculo externo (bolinha)
                const midAngle = (startAngle + endAngle) / 2;
                const bubbleDistance = radius + bubbleRadius + 10;
                const bubbleX = centerX + bubbleDistance * Math.cos(midAngle * Math.PI / 180);
                const bubbleY = centerY + bubbleDistance * Math.sin(midAngle * Math.PI / 180);

                // Criar c√≠rculo (bolinha)
                const circle = document.createElementNS(svgNS, 'circle');
                circle.setAttribute('cx', bubbleX);
                circle.setAttribute('cy', bubbleY);
                circle.setAttribute('r', bubbleRadius);
                circle.setAttribute('fill', cat.color);
                circle.setAttribute('filter', 'url(#circle-shadow)');
                circle.classList.add('bolinha');
                circle.style.animationDelay = `${(index + 1) * 0.15}s`;
                svg.appendChild(circle);

                // Criar texto dentro do c√≠rculo
                const text = document.createElementNS(svgNS, 'text');
                text.setAttribute('x', bubbleX);
                text.setAttribute('y', bubbleY + 14);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('font-size', '42');
                text.setAttribute('font-weight', 'bold');
                text.setAttribute('font-family', 'Open Sans, sans-serif');
                text.setAttribute('fill', 'white');
                text.setAttribute('letter-spacing', '-2');
                text.classList.add('bolinha');
                text.style.animationDelay = `${(index + 1) * 0.15}s`;
                text.textContent = cat.score;

                const tspan = document.createElementNS(svgNS, 'tspan');
                tspan.setAttribute('font-size', '20');
                tspan.textContent = '%';
                text.appendChild(tspan);

                svg.appendChild(text);

                // Criar label no arco interno (labels devem estar dentro do defs E depois renderizados)
                const labelRadius = 250; // Raio para os labels (entre innerRadius e radius)
                const labelPath = createArcPath(centerX, centerY, labelRadius, startAngle, endAngle);
                const labelPathElement = document.createElementNS(svgNS, 'path');
                labelPathElement.setAttribute('id', `arc-label-${index}`);
                labelPathElement.setAttribute('d', labelPath);
                labelPathElement.setAttribute('fill', 'none');
                defs.appendChild(labelPathElement);

                currentAngle = endAngle;
            });

            // Adicionar labels nas fatias (ANTES do c√≠rculo branco para ficarem atr√°s)
            categories.forEach((cat, index) => {
                const labelText = document.createElementNS(svgNS, 'text');
                labelText.setAttribute('font-size', '22');
                labelText.setAttribute('font-weight', '900');
                labelText.setAttribute('font-family', 'brandon-grotesque, Open Sans, sans-serif');
                labelText.setAttribute('fill', cat.color);
                labelText.classList.add('logo', 'logo-animate');

                const textPath = document.createElementNS(svgNS, 'textPath');
                textPath.setAttributeNS('http://www.w3.org/1999/xlink', 'href', `#arc-label-${index}`);
                textPath.setAttribute('startOffset', '50%');
                textPath.setAttribute('text-anchor', 'middle');
                textPath.textContent = cat.label.toUpperCase();
                labelText.appendChild(textPath);

                svg.appendChild(labelText);
            });

            // Criar c√≠rculo branco central
            const whiteCircle = document.createElementNS(svgNS, 'circle');
            whiteCircle.setAttribute('cx', centerX);
            whiteCircle.setAttribute('cy', centerY);
            whiteCircle.setAttribute('r', innerRadius);
            whiteCircle.setAttribute('fill', 'white');
            whiteCircle.setAttribute('fill-opacity', '0.95');
            svg.appendChild(whiteCircle);

            // Logo no centro (se tiver)
            const logoImage = document.createElementNS(svgNS, 'image');
            logoImage.setAttributeNS('http://www.w3.org/1999/xlink', 'href', '/assets/images/logo-ocea.png');
            logoImage.setAttribute('x', centerX - 70);
            logoImage.setAttribute('y', centerY - 100);
            logoImage.setAttribute('width', '140');
            logoImage.setAttribute('height', '60');
            svg.appendChild(logoImage);

            // Texto "MAPA"
            const mapaText = document.createElementNS(svgNS, 'text');
            mapaText.setAttribute('x', centerX);
            mapaText.setAttribute('y', centerY + 60);
            mapaText.setAttribute('text-anchor', 'middle');
            mapaText.setAttribute('font-size', '60');
            mapaText.setAttribute('font-weight', '900');
            mapaText.setAttribute('font-family', 'Open Sans, sans-serif');
            mapaText.setAttribute('fill', '#4c4748');
            mapaText.textContent = 'MAPA';
            svg.appendChild(mapaText);

            // Texto "DA SUA SA√öDE"
            const saudeText = document.createElementNS(svgNS, 'text');
            saudeText.setAttribute('x', centerX);
            saudeText.setAttribute('y', centerY + 95);
            saudeText.setAttribute('text-anchor', 'middle');
            saudeText.setAttribute('font-size', '34');
            saudeText.setAttribute('font-weight', '300');
            saudeText.setAttribute('font-family', 'Open Sans, sans-serif');
            saudeText.setAttribute('fill', '#4c4748');
            saudeText.textContent = 'DA SUA SA√öDE';
            svg.appendChild(saudeText);

            // Adicionar SVG ao container
            document.getElementById('svg-container').appendChild(svg);
        }

        // =============================================
        // FUN√á√ïES AUXILIARES PARA SVG
        // =============================================

        function createDonutSlice(cx, cy, radius, innerRadius, startAngle, endAngle) {
            const start = polarToCartesian(cx, cy, radius, endAngle);
            const end = polarToCartesian(cx, cy, radius, startAngle);
            const innerStart = polarToCartesian(cx, cy, innerRadius, endAngle);
            const innerEnd = polarToCartesian(cx, cy, innerRadius, startAngle);

            const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

            return [
                "M", start.x, start.y,
                "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y,
                "L", innerEnd.x, innerEnd.y,
                "A", innerRadius, innerRadius, 0, largeArcFlag, 1, innerStart.x, innerStart.y,
                "Z"
            ].join(" ");
        }

        function createArcPath(cx, cy, radius, startAngle, endAngle) {
            const start = polarToCartesian(cx, cy, radius, startAngle);
            const end = polarToCartesian(cx, cy, radius, endAngle);
            const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

            return [
                "M", start.x, start.y,
                "A", radius, radius, 0, largeArcFlag, 1, end.x, end.y
            ].join(" ");
        }

        function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
            const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
            return {
                x: centerX + (radius * Math.cos(angleInRadians)),
                y: centerY + (radius * Math.sin(angleInRadians))
            };
        }

        // =============================================
        // INICIALIZA√á√ÉO
        // =============================================

        window.addEventListener('DOMContentLoaded', () => {
            // Verificar autentica√ß√£o
            if (!API.Auth.isAuthenticated()) {
                window.location.href = '/login.html';
                return;
            }

            loadDiagnostic();
        });
    </script>

</body>
</html>
